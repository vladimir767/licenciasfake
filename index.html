<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Licencias ArgentinaRP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .animated-gradient {
      background: linear-gradient(-45deg, #1e3a8a, #3b82f6, #06b6d4, #0891b2);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    * {
      -webkit-tap-highlight-color: transparent;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>

<body class="min-h-screen animated-gradient p-2 sm:p-4">

  <div class="max-w-7xl mx-auto">
    <!-- PANTALLA DE BIENVENIDA -->
    <div id="pantallaInicio" class="glass-effect rounded-2xl shadow-2xl overflow-hidden">
      <div class="p-8 sm:p-16 text-white text-center">
        <div class="mb-8">
          <div class="w-24 h-24 mx-auto bg-white/20 rounded-full flex items-center justify-center mb-6">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
          </div>
        </div>
        <h1 class="text-3xl sm:text-5xl font-bold mb-4">
          Centro de Licencias
        </h1>
        <p class="text-xl sm:text-2xl font-light mb-2">Argentina Roleplay</p>
        <p class="text-blue-100 text-base sm:text-lg mb-8">Sistema Oficial de Gesti√≥n de Licencias</p>
        <button onclick="mostrarSistema()"
                class="bg-white text-blue-600 px-8 sm:px-12 py-4 rounded-xl font-bold text-lg sm:text-xl hover:bg-blue-50 shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300">
          üöÄ Acceder al Sistema
        </button>
      </div>
    </div>

    <!-- SISTEMA COMPLETO -->
    <div id="sistemaCompleto" class="hidden space-y-6">
      
      <!-- HEADER -->
      <div class="glass-effect rounded-2xl shadow-2xl p-6 sm:p-8 text-white">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="text-2xl sm:text-4xl font-bold">
              üé´ Sistema de Licencias
            </h1>
            <p class="text-blue-100 mt-2 text-sm sm:text-base">Argentina Roleplay ‚Ä¢ Centro de Gesti√≥n</p>
          </div>
          <button onclick="mostrarEstadisticas()" class="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-xl font-medium transition">
            üìä Estad√≠sticas
          </button>
        </div>
      </div>

      <!-- B√öSQUEDA Y ACCIONES -->
      <div class="glass-effect rounded-2xl shadow-2xl p-6">
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1 relative">
            <input id="searchInput"
                   type="text"
                   placeholder="üîç Buscar por nombre o n√∫mero..."
                   class="w-full pl-12 pr-4 py-4 bg-white/90 border-2 border-white/30 rounded-xl focus:ring-4 focus:ring-blue-300 text-base font-medium" />
            <svg class="w-6 h-6 absolute left-4 top-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <button onclick="solicitarClave()"
                  class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-4 rounded-xl font-bold text-base shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300">
            ‚ûï Registrar Licencia
          </button>
        </div>
      </div>

      <!-- CONTADOR -->
      <div id="contador" class="glass-effect rounded-2xl shadow-2xl p-6 text-white text-center">
        <p class="text-lg font-medium">Licencias Registradas</p>
        <p class="text-5xl font-bold mt-2">0</p>
      </div>

      <!-- LISTA DE LICENCIAS -->
      <div class="glass-effect rounded-2xl shadow-2xl p-6">
        <h2 class="text-2xl font-bold mb-6 text-white flex items-center gap-3">
          <span>üìã</span> Registro de Licencias
        </h2>
        <div id="listaLicencias" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
      </div>

      <!-- FORMULARIO -->
      <div id="formulario" class="hidden glass-effect rounded-2xl shadow-2xl p-6 sm:p-8">
        <div class="max-w-3xl mx-auto">
          <h2 class="text-3xl font-bold mb-8 text-white text-center">‚ú® Registrar Nueva Licencia</h2>

          <div class="space-y-6">
            <div class="bg-white/90 rounded-xl p-4">
              <label class="block text-sm font-bold text-gray-700 mb-2">üë§ Nombre y Apellido *</label>
              <input id="nombre" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base focus:ring-4 focus:ring-blue-300" placeholder="Ej: Juan P√©rez" />
            </div>

            <div class="bg-white/90 rounded-xl p-4">
              <label class="block text-sm font-bold text-gray-700 mb-2">üöó Tipo de Licencia *</label>
              <select id="tipoLicencia" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base focus:ring-4 focus:ring-blue-300">
                <option value="">Seleccione una opci√≥n</option>
                <option value="Deportivos">üèéÔ∏è Deportivos</option>
                <option value="Electricos">‚ö° El√©ctricos</option>
                <option value="Clasicos">üöô Cl√°sicos</option>
                <option value="Motocicletas">üèçÔ∏è Motocicletas</option>
                <option value="Camiones">üöõ Camiones</option>
              </select>
            </div>

            <div class="bg-white/90 rounded-xl p-4">
              <label class="block text-sm font-bold text-gray-700 mb-2">üî¢ N¬∞ De Registro *</label>
              <input id="numero" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base focus:ring-4 focus:ring-blue-300" placeholder="Ej: DL-2024-001234" />
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="bg-white/90 rounded-xl p-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">üìÖ Fecha de Registro *</label>
                <input id="fechaRegistro" type="date" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base focus:ring-4 focus:ring-blue-300" />
              </div>

              <div class="bg-white/90 rounded-xl p-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">üîÑ Fecha de Renovaci√≥n *</label>
                <input id="fechaRenovacion" type="date" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base focus:ring-4 focus:ring-blue-300" />
              </div>
            </div>

            <div class="bg-white/90 rounded-xl p-4">
              <label class="block text-sm font-bold text-gray-700 mb-2">‚úçÔ∏è Firma Responsable *</label>
              <input id="firma" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base focus:ring-4 focus:ring-blue-300" placeholder="Ej: Dr. Carlos Rodr√≠guez" />
            </div>

            <div class="bg-white/90 rounded-xl p-4">
              <label class="block text-sm font-bold text-gray-700 mb-2">üì∏ Foto de Perfil *</label>
              <input type="file" accept="image/*" id="fotoInput" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base" />
              <img id="fotoPreview" class="mt-4 w-40 h-40 object-cover rounded-xl hidden border-4 border-blue-500 mx-auto shadow-xl" />
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-4 mt-8">
            <button onclick="registrarLicencia()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300">
              üíæ Registrar Licencia
            </button>
            <button onclick="cerrarFormulario()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-4 rounded-xl font-bold text-lg shadow-xl transition duration-300">
              ‚ùå Cancelar
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4 z-50" style="background: rgba(0, 0, 0, 0.7);" onclick="cerrarModalClick(event)">
    <div class="bg-gradient-to-br from-white to-gray-100 rounded-2xl max-w-3xl w-full p-6 sm:p-8 shadow-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
      <img id="modalFoto" class="w-40 h-40 sm:w-48 sm:h-48 mx-auto rounded-2xl object-cover border-4 border-blue-500 shadow-2xl" />
      <h3 id="modalNombre" class="text-2xl sm:text-3xl font-bold mt-6 text-gray-800 text-center"></h3>

      <div class="mt-6 space-y-3 bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200">
        <div class="flex justify-between items-center py-2 border-b border-gray-300">
          <span class="font-bold text-gray-700">üöó Tipo:</span>
          <span id="modalTipo" class="text-right font-medium text-blue-600"></span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-gray-300">
          <span class="font-bold text-gray-700">üî¢ N¬∞ Registro:</span>
          <span id="modalNumero" class="text-right font-medium"></span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-gray-300">
          <span class="font-bold text-gray-700">üìÖ Fecha Registro:</span>
          <span id="modalFechaRegistro" class="text-right font-medium"></span>
        </div>
        <div class="flex justify-between items-center py-2 border-b border-gray-300">
          <span class="font-bold text-gray-700">üîÑ Fecha Renovaci√≥n:</span>
          <span id="modalFechaRenovacion" class="text-right font-medium"></span>
        </div>
        <div class="flex justify-between items-center py-2">
          <span class="font-bold text-gray-700">‚úçÔ∏è Firma:</span>
          <span id="modalFirma" class="text-right font-medium"></span>
        </div>
      </div>

      <div class="mt-6 p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-300">
        <h4 class="font-bold text-gray-800 mb-4 text-center text-lg">üé´ Generar Licencia Oficial</h4>
        <button onclick="generarYDescargarLicencia()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300">
          üì∏ Generar y Descargar
        </button>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 mt-6">
        <button onclick="confirmarEliminar()" class="flex-1 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition duration-300">
          üóëÔ∏è Eliminar
        </button>
        <button onclick="cerrarModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-4 rounded-xl font-bold text-lg shadow-xl transition duration-300">
          ‚úñÔ∏è Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- CANVAS OCULTO -->
  <canvas id="licenseCanvas" width="1456" height="816" style="display: none;"></canvas>

  <script>
    let licencias = {};
    let licenciaActual = null;
    const STORAGE_KEY = 'licenciasArgRP_v2';
    const MAX_IMAGE_SIZE = 400; // Reducir tama√±o de im√°genes

    // ============ NOTIFICACIONES ============
    function mostrarNotificacion(mensaje, tipo = 'success') {
      const colores = {
        success: 'from-green-500 to-emerald-600',
        error: 'from-red-500 to-red-600',
        info: 'from-blue-500 to-indigo-600'
      };
      
      const iconos = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };

      const notif = document.createElement('div');
      notif.className = `notification bg-gradient-to-r ${colores[tipo]} text-white px-6 py-4 rounded-xl shadow-2xl font-bold`;
      notif.innerHTML = `${iconos[tipo]} ${mensaje}`;
      document.body.appendChild(notif);

      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // ============ COMPRESI√ìN DE IM√ÅGENES ============
    function comprimirImagen(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Redimensionar manteniendo aspecto
            if (width > height) {
              if (width > MAX_IMAGE_SIZE) {
                height *= MAX_IMAGE_SIZE / width;
                width = MAX_IMAGE_SIZE;
              }
            } else {
              if (height > MAX_IMAGE_SIZE) {
                width *= MAX_IMAGE_SIZE / height;
                height = MAX_IMAGE_SIZE;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Comprimir a JPEG 0.7 calidad
            const compressed = canvas.toDataURL('image/jpeg', 0.7);
            resolve(compressed);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ============ STORAGE ============
    function cargarLicencias() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          licencias = JSON.parse(data);
          console.log('‚úì Licencias cargadas:', Object.keys(licencias).length);
        }
      } catch (error) {
        console.error('Error al cargar:', error);
        licencias = {};
      }
      actualizarContador();
      renderizarLicencias();
    }

    function guardarLicencias() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(licencias));
        console.log('‚úì Guardado exitoso');
        return true;
      } catch (error) {
        console.error('Error al guardar:', error);
        if (error.name === 'QuotaExceededError') {
          mostrarNotificacion('Almacenamiento lleno. Elimina licencias antiguas.', 'error');
        }
        return false;
      }
    }

    // ============ UI PRINCIPAL ============
    function mostrarSistema() {
      document.getElementById("pantallaInicio").classList.add("hidden");
      document.getElementById("sistemaCompleto").classList.remove("hidden");
      cargarLicencias();
      mostrarNotificacion('Bienvenido al sistema', 'info');
    }

    function actualizarContador() {
      const total = Object.keys(licencias).length;
      document.getElementById("contador").querySelector("p:last-child").textContent = total;
    }

    function mostrarEstadisticas() {
      const total = Object.keys(licencias).length;
      const tipos = {};
      
      Object.values(licencias).forEach(lic => {
        tipos[lic.tipoLicencia] = (tipos[lic.tipoLicencia] || 0) + 1;
      });

      let mensaje = `üìä ESTAD√çSTICAS DEL SISTEMA\n\n`;
      mensaje += `Total de licencias: ${total}\n\n`;
      mensaje += `Por tipo:\n`;
      
      for (const [tipo, cantidad] of Object.entries(tipos)) {
        mensaje += `‚Ä¢ ${tipo}: ${cantidad}\n`;
      }

      alert(mensaje);
    }

    // ============ FORMULARIO ============
    function solicitarClave() {
      const clave = prompt("üîê Ingrese la clave de acceso:");
      
      if (clave === "LicenciasArgentina2025") {
        mostrarFormulario();
      } else if (clave !== null) {
        mostrarNotificacion('Clave incorrecta', 'error');
      }
    }

    function mostrarFormulario() {
      document.getElementById("formulario").classList.remove("hidden");
      setTimeout(() => {
        document.getElementById("formulario").scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    function cerrarFormulario() {
      document.getElementById("formulario").classList.add("hidden");
      limpiarFormulario();
    }

    function limpiarFormulario() {
      document.getElementById("nombre").value = "";
      document.getElementById("tipoLicencia").value = "";
      document.getElementById("numero").value = "";
      document.getElementById("fechaRegistro").value = "";
      document.getElementById("fechaRenovacion").value = "";
      document.getElementById("firma").value = "";
      document.getElementById("fotoInput").value = "";
      document.getElementById("fotoPreview").classList.add("hidden");
    }

    document.getElementById("fotoInput").addEventListener("change", async function(e) {
      const file = e.target.files[0];
      if (!file) return;

      try {
        mostrarNotificacion('Comprimiendo imagen...', 'info');
        const compressed = await comprimirImagen(file);
        const preview = document.getElementById("fotoPreview");
        preview.src = compressed;
        preview.classList.remove("hidden");
        mostrarNotificacion('Imagen cargada correctamente', 'success');
      } catch (error) {
        mostrarNotificacion('Error al procesar imagen', 'error');
      }
    });

    function registrarLicencia() {
      const nombre = document.getElementById("nombre").value.trim();
      const tipoLicencia = document.getElementById("tipoLicencia").value;
      const numero = document.getElementById("numero").value.trim();
      const fechaRegistro = document.getElementById("fechaRegistro").value;
      const fechaRenovacion = document.getElementById("fechaRenovacion").value;
      const firma = document.getElementById("firma").value.trim();
      const fotoSrc = document.getElementById("fotoPreview").src;

      if (!nombre || !tipoLicencia || !numero || !fechaRegistro || !fechaRenovacion || !firma || !fotoSrc || fotoSrc.includes('data:image/svg')) {
        mostrarNotificacion('Completa todos los campos incluyendo la foto', 'error');
        return;
      }

      if (licencias[numero]) {
        mostrarNotificacion('Ya existe una licencia con ese n√∫mero', 'error');
        return;
      }

      const licencia = {
        id: Date.now(),
        nombre,
        tipoLicencia,
        numero,
        fechaRegistro,
        fechaRenovacion,
        firma,
        foto: fotoSrc
      };

      licencias[numero] = licencia;
      
      if (guardarLicencias()) {
        mostrarNotificacion('Licencia registrada exitosamente', 'success');
        cerrarFormulario();
        actualizarContador();
        renderizarLicencias();
      }
    }

    // ============ RENDERIZADO ============
    function renderizarLicencias() {
      const lista = document.getElementById("listaLicencias");
      lista.innerHTML = "";

      const licenciasArray = Object.values(licencias);

      if (licenciasArray.length === 0) {
        lista.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-white text-xl font-medium">üì≠ No hay licencias registradas</p><p class="text-blue-200 mt-2">Registra la primera licencia para comenzar</p></div>';
        return;
      }

      // Ordenar por fecha (m√°s recientes primero)
      licenciasArray.sort((a, b) => b.id - a.id);

      licenciasArray.forEach(lic => {
        const card = document.createElement("div");
        card.className = "bg-gradient-to-br from-white to-gray-50 rounded-xl p-5 cursor-pointer shadow-xl card-hover border-2 border-white/50";
        card.onclick = () => abrirModal(lic);

        const tipoEmoji = {
          'Deportivos': 'üèéÔ∏è',
          'Electricos': '‚ö°',
          'Clasicos': 'üöô',
          'Motocicletas': 'üèçÔ∏è',
          'Camiones': 'üöõ'
        };

        card.innerHTML = `
          <div class="flex gap-4">
            <img src="${lic.foto}" class="w-20 h-20 object-cover rounded-xl bg-gray-300 flex-shrink-0 border-2 border-blue-400 shadow-lg" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2240%22%3Eüë§%3C/text%3E%3C/svg%3E'" />
            <div class="flex-1 min-w-0">
              <h3 class="font-bold text-lg truncate text-gray-800">${lic.nombre}</h3>
              <p class="text-base text-blue-600 font-bold">${tipoEmoji[lic.tipoLicencia] || 'üöó'} ${lic.tipoLicencia}</p>
              <p class="text-sm text-gray-600 truncate">N¬∞: ${lic.numero}</p>
              <p class="text-xs text-gray-500 mt-1">üìÖ ${lic.fechaRegistro}</p>
            </div>
          </div>
        `;

        lista.appendChild(card);
      });
    }

    // ============ MODAL ============
    function abrirModal(lic) {
      licenciaActual = lic;
      document.getElementById("modalFoto").src = lic.foto;
      document.getElementById("modalNombre").textContent = lic.nombre;
      document.getElementById("modalTipo").textContent = lic.tipoLicencia;
      document.getElementById("modalNumero").textContent = lic.numero;
      document.getElementById("modalFechaRegistro").textContent = lic.fechaRegistro;
      document.getElementById("modalFechaRenovacion").textContent = lic.fechaRenovacion;
      document.getElementById("modalFirma").textContent = lic.firma;
      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("modal").classList.add("flex");
      document.body.style.overflow = 'hidden';
    }

    function cerrarModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modal").classList.remove("flex");
      document.body.style.overflow = 'auto';
    }

    function cerrarModalClick(event) {
      if (event.target.id === 'modal') {
        cerrarModal();
      }
    }

    function confirmarEliminar() {
      if (confirm("‚ö†Ô∏è ¬øEliminar esta licencia?\n\nEsta acci√≥n no se puede deshacer.")) {
        delete licencias[licenciaActual.numero];
        if (guardarLicencias()) {
          mostrarNotificacion('Licencia eliminada', 'success');
          cerrarModal();
          actualizarContador();
          renderizarLicencias();
        }
      }
    }

    // ============ GENERACI√ìN DE LICENCIA ============
    function generarYDescargarLicencia() {
      if (!licenciaActual) {
        mostrarNotificacion('Error: No hay licencia seleccionada', 'error');
        return;
      }

      mostrarNotificacion('Generando licencia...', 'info');

      setTimeout(() => {
        try {
          const canvas = document.getElementById('licenseCanvas');
          const ctx = canvas.getContext('2d');

          // Limpiar canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Fondo principal
          const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
          gradient.addColorStop(0, '#1e3a8a');
          gradient.addColorStop(0.5, '#3b82f6');
          gradient.addColorStop(1, '#06b6d4');
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Header superior
          ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
          ctx.fillRect(0, 0, canvas.width, 120);

          // Logo LC
          ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
          ctx.beginPath();
          ctx.arc(100, 60, 40, 0, 2 * Math.PI);
          ctx.fill();
          ctx.fillStyle = '#1e3a8a';
          ctx.font = 'bold 32px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('LC', 100, 72);

          // T√≠tulo
          ctx.fillStyle = 'white';
          ctx.font = 'bold 52px Arial';
          ctx.textAlign = 'left';
          ctx.fillText('LICENCIA DE CONDUCIR', 170, 75);

          // Contenedor principal (card blanco)
          ctx.fillStyle = 'white';
          ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
          ctx.shadowBlur = 30;
          ctx.shadowOffsetX = 0;
          ctx.shadowOffsetY = 10;
          ctx.fillRect(60, 160, 1336, 520);
          ctx.shadowColor = 'transparent';
          ctx.shadowBlur = 0;

          // Cargar y dibujar foto
          const userPhoto = new Image();
          userPhoto.crossOrigin = "anonymous";
          
          userPhoto.onload = function() {
            // √Årea de foto
            ctx.save();
            ctx.beginPath();
            ctx.roundRect(100, 200, 300, 380, 15);
            ctx.clip();
            
            const aspectRatio = userPhoto.width / userPhoto.height;
            let drawWidth, drawHeight, offsetX, offsetY;
            
            if (aspectRatio > 300/380) {
              drawHeight = 380;
              drawWidth = drawHeight * aspectRatio;
              offsetX = 100 - (drawWidth - 300) / 2;
              offsetY = 200;
            } else {
              drawWidth = 300;
              drawHeight = drawWidth / aspectRatio;
              offsetX = 100;
              offsetY = 200 - (drawHeight - 380) / 2;
            }
            
            ctx.drawImage(userPhoto, offsetX, offsetY, drawWidth, drawHeight);
            ctx.restore();

            // Borde de foto
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.roundRect(100, 200, 300, 380, 15);
            ctx.stroke();

            // Marca de agua
            ctx.save();
            ctx.globalAlpha = 0.05;
            ctx.fillStyle = '#1e3a8a';
            ctx.font = 'bold 120px Arial';
            ctx.textAlign = 'center';
            ctx.translate(728, 420);
            ctx.rotate(-25 * Math.PI / 180);
            ctx.fillText('ArgentinaRP', 0, 0);
            ctx.restore();

            // DATOS DE LA LICENCIA
            let yPos = 250;
            const leftMargin = 450;

            // Nombre
            ctx.fillStyle = '#1e3a8a';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('NOMBRE / NAME', leftMargin, yPos);
            ctx.fillStyle = '#666';
            ctx.font = '20px Arial';
            ctx.fillText('[Nombre del titular]', leftMargin, yPos + 25);
            ctx.fillStyle = '#3b82f6';
            ctx.font = 'bold 36px Arial';
            ctx.fillText(licenciaActual.nombre, leftMargin, yPos + 65);

            // N¬∞ Licencia
            yPos += 110;
            ctx.fillStyle = '#1e3a8a';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('N¬∞ LICENCIA / LICENSE N¬∞', leftMargin, yPos);
            ctx.fillStyle = '#666';
            ctx.font = '20px Arial';
            ctx.fillText('[N√∫mero de registro]', leftMargin, yPos + 25);
            ctx.fillStyle = '#3b82f6';
            ctx.font = 'bold 36px Arial';
            ctx.fillText(licenciaActual.numero, leftMargin, yPos + 65);

            // Tipo
            yPos += 110;
            ctx.fillStyle = '#1e3a8a';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('TIPO / TYPE', leftMargin, yPos);
            ctx.fillStyle = '#666';
            ctx.font = '20px Arial';
            ctx.fillText('[Categor√≠a de veh√≠culo]', leftMargin, yPos + 25);
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 36px Arial';
            ctx.fillText(licenciaActual.tipoLicencia, leftMargin, yPos + 65);

            // Fechas
            yPos += 110;
            ctx.fillStyle = '#1e3a8a';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('REGISTRO: ' + licenciaActual.fechaRegistro, leftMargin, yPos);
            ctx.fillText('RENOVACI√ìN: ' + licenciaActual.fechaRenovacion, leftMargin, yPos + 35);

            // QR Code (simplificado)
            const qrSize = 150;
            const qrX = 1180;
            const qrY = 200;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(qrX, qrY, qrSize, qrSize);
            ctx.strokeStyle = '#1e3a8a';
            ctx.lineWidth = 3;
            ctx.strokeRect(qrX, qrY, qrSize, qrSize);
            
            ctx.fillStyle = '#1e3a8a';
            for (let i = 0; i < 6; i++) {
              for (let j = 0; j < 6; j++) {
                if ((i + j) % 2 === 0) {
                  ctx.fillRect(qrX + 10 + i * 22, qrY + 10 + j * 22, 18, 18);
                }
              }
            }
            
            ctx.fillStyle = '#1e3a8a';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('SCAN ME', qrX + qrSize/2, qrY + qrSize + 25);

            // Footer
            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.fillRect(0, 710, canvas.width, 106);

            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üá¶üá∑ ARGENTINA ROLEPLAY ‚Ä¢ SISTEMA OFICIAL DE LICENCIAS', 728, 770);

            // Firma
            ctx.font = '24px Arial';
            ctx.fillText('Firma: ' + licenciaActual.firma, 728, 800);

            // Descargar despu√©s de renderizar
            setTimeout(() => descargarImagen(), 200);
          };

          userPhoto.onerror = function() {
            console.error('Error al cargar foto');
            mostrarNotificacion('Error al cargar la foto', 'error');
          };

          userPhoto.src = licenciaActual.foto;

        } catch (error) {
          console.error('Error:', error);
          mostrarNotificacion('Error al generar: ' + error.message, 'error');
        }
      }, 100);
    }

    function descargarImagen() {
      try {
        const canvas = document.getElementById('licenseCanvas');
        const dataURL = canvas.toDataURL('image/png', 1.0);
        const link = document.createElement('a');
        const nombreArchivo = `Licencia_${licenciaActual.numero.replace(/[^a-zA-Z0-9]/g, '_')}_${licenciaActual.nombre.replace(/\s+/g, '_')}.png`;
        
        link.download = nombreArchivo;
        link.href = dataURL;
        link.click();
        
        mostrarNotificacion('¬°Licencia descargada exitosamente!', 'success');
      } catch (error) {
        console.error('Error al descargar:', error);
        mostrarNotificacion('Error al descargar: ' + error.message, 'error');
      }
    }

    // ============ B√öSQUEDA ============
    document.getElementById("searchInput").addEventListener("input", function(e) {
      const busqueda = e.target.value.toLowerCase().trim();
      const cards = document.querySelectorAll("#listaLicencias > div");
      
      let visibles = 0;
      cards.forEach(card => {
        const texto = card.textContent.toLowerCase();
        if (texto.includes(busqueda)) {
          card.style.display = "block";
          visibles++;
        } else {
          card.style.display = "none";
        }
      });

      if (visibles === 0 && busqueda) {
        document.getElementById("listaLicencias").innerHTML = '<div class="col-span-full text-center py-12"><p class="text-white text-xl font-medium">üîç No se encontraron resultados</p><p class="text-blue-200 mt-2">Intenta con otro t√©rmino de b√∫squeda</p></div>';
      } else if (visibles === 0 && !busqueda) {
        renderizarLicencias();
      }
    });

    // ============ ATAJOS DE TECLADO ============
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (!document.getElementById('modal').classList.contains('hidden')) {
          cerrarModal();
        } else if (!document.getElementById('formulario').classList.contains('hidden')) {
          cerrarFormulario();
        }
      }
    });

    // ============ INICIALIZACI√ìN ============
    cargarLicencias();
  </script>
</body>
</html>
